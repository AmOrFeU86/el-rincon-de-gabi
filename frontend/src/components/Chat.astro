---
// Chat component con input central flotante y panel lateral
---

<!-- Librería para renderizar Markdown -->
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

<div
  x-data="{
    isOpen: false,
    messages: [],
    inputMessage: '',
    isLoading: false,
    chatWidth: 384,
    isResizing: false,
    startX: 0,
    startWidth: 0,

    formatMarkdown(text) {
      if (typeof marked === 'undefined') return text;
      let html = marked.parse(text);
      // Añadir target=&quot;_blank&quot; a todos los enlaces, manteniendo sus atributos originales
      html = html.replace(/<a /g, '<a target=&quot;_blank&quot; rel=&quot;noopener noreferrer&quot; ');
      return html;
    },

    startResize(e) {
      this.isResizing = true;
      this.startX = e.clientX;
      this.startWidth = this.chatWidth;
      document.body.style.userSelect = 'none';
      document.body.style.cursor = 'ew-resize';
    },

    onResize(e) {
      if (!this.isResizing) return;
      const diff = this.startX - e.clientX;
      const newWidth = this.startWidth + diff;
      this.chatWidth = Math.max(320, Math.min(800, newWidth));
    },

    stopResize() {
      this.isResizing = false;
      document.body.style.userSelect = '';
      document.body.style.cursor = '';
    },

    async sendMessage() {
      if (!this.inputMessage.trim()) return;

      // Si el chat no está abierto, abrirlo
      if (!this.isOpen) {
        this.isOpen = true;
      }

      // Añadir mensaje del usuario
      const userMessage = this.inputMessage.trim();
      this.messages.push({ role: 'user', content: userMessage });
      this.inputMessage = '';
      this.isLoading = true;

      // Hacer scroll al final
      this.$nextTick(() => {
        const container = this.$refs.messagesContainer;
        if (container) container.scrollTop = container.scrollHeight;
      });

      try {
        // Llamar al endpoint del chat
        const response = await fetch('http://localhost:8000/chat', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            messages: this.messages
          })
        });

        if (!response.ok) throw new Error('Error en la respuesta');

        const data = await response.json();
        this.messages.push(data);

        // Hacer scroll al final
        this.$nextTick(() => {
          const container = this.$refs.messagesContainer;
          if (container) container.scrollTop = container.scrollHeight;
        });

      } catch (error) {
        console.error('Error:', error);
        this.messages.push({
          role: 'assistant',
          content: 'Lo siento, hubo un error al procesar tu mensaje. Por favor, intenta de nuevo.'
        });
      } finally {
        this.isLoading = false;
      }
    },

    closeChat() {
      this.isOpen = false;
    }
}"
  @mousemove.window="onResize($event)"
  @mouseup.window="stopResize()"
  class="fixed inset-0 pointer-events-none z-50"
>
  <!-- Input central flotante (cuando el chat NO está abierto) -->
  <div
    x-show="!isOpen"
    x-transition:enter="transition ease-out duration-300"
    x-transition:enter-start="opacity-0 translate-y-4"
    x-transition:enter-end="opacity-100 translate-y-0"
    x-transition:leave="transition ease-in duration-200"
    x-transition:leave-start="opacity-100 translate-y-0"
    x-transition:leave-end="opacity-0 translate-y-4"
    class="absolute bottom-8 left-1/2 -translate-x-1/2 w-full max-w-2xl px-4 pointer-events-auto"
  >
    <form @submit.prevent="sendMessage" class="relative">
      <input
        x-model="inputMessage"
        type="text"
        placeholder="Pregúntame sobre agentes de IA..."
        class="w-full px-6 py-4 pr-14 rounded-3xl bg-gray-800/70 backdrop-blur-sm text-gray-100 placeholder-gray-400 border border-gray-700 focus:bg-gray-800 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent shadow-2xl transition-all duration-200 focus:scale-105 focus:py-5 focus:rounded-2xl"
      />
      <button
        type="submit"
        class="absolute right-2 top-1/2 -translate-y-1/2 p-2.5 bg-blue-600 hover:bg-blue-700 rounded-full transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
        :disabled="!inputMessage.trim()"
      >
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
          <path d="M10.894 2.553a1 1 0 00-1.788 0l-7 14a1 1 0 001.169 1.409l5-1.429A1 1 0 009 15.571V11a1 1 0 112 0v4.571a1 1 0 00.725.962l5 1.428a1 1 0 001.17-1.408l-7-14z" />
        </svg>
      </button>
    </form>
  </div>

  <!-- Panel lateral derecho (cuando el chat ESTÁ abierto) -->
  <div
    x-show="isOpen"
    x-transition:enter="transition ease-out duration-300"
    x-transition:enter-start="translate-x-full"
    x-transition:enter-end="translate-x-0"
    x-transition:leave="transition ease-in duration-200"
    x-transition:leave-start="translate-x-0"
    x-transition:leave-end="translate-x-full"
    :style="`width: ${window.innerWidth < 768 ? '100%' : chatWidth + 'px'}`"
    class="absolute right-0 top-0 h-full bg-gray-900 border-l border-gray-800 shadow-2xl flex flex-col pointer-events-auto"
  >
    <!-- Resize handle -->
    <div
      @mousedown="startResize($event)"
      class="absolute left-0 top-0 h-full w-1 cursor-ew-resize hover:bg-blue-500/50 transition-colors group"
      style="margin-left: -2px;"
    >
      <div class="absolute left-0 top-1/2 -translate-y-1/2 w-1 h-12 bg-gray-600 rounded-r group-hover:bg-blue-500 transition-colors"></div>
    </div>
    <!-- Header -->
    <div class="flex items-center justify-between p-4 border-b border-gray-800">
      <h3 class="text-lg font-semibold text-gray-100">Chat de Ayuda</h3>
      <button
        @click="closeChat"
        class="p-2 hover:bg-gray-800 rounded-lg transition-colors"
        aria-label="Cerrar chat"
      >
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
          <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" />
        </svg>
      </button>
    </div>

    <!-- Mensajes -->
    <div
      x-ref="messagesContainer"
      class="flex-1 overflow-y-auto p-4 space-y-4"
    >
      <!-- Mensaje de bienvenida -->
      <template x-if="messages.length === 0">
        <div class="text-center text-gray-400 py-8">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 mx-auto mb-4 opacity-50" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z" />
          </svg>
          <p class="text-sm">Hola! Pregúntame lo que quieras sobre agentes de IA</p>
        </div>
      </template>

      <!-- Mensajes del chat -->
      <template x-for="(msg, index) in messages" :key="index">
        <div :class="msg.role === 'user' ? 'flex justify-end' : 'flex justify-start'">
          <div
            :class="msg.role === 'user'
              ? 'bg-blue-600 text-white rounded-2xl rounded-tr-sm'
              : 'bg-gray-800 text-gray-100 rounded-2xl rounded-tl-sm'"
            class="max-w-[85%] px-4 py-2.5 break-words"
          >
            <!-- Mensaje del usuario (texto plano) -->
            <template x-if="msg.role === 'user'">
              <p class="text-sm whitespace-pre-wrap" x-text="msg.content"></p>
            </template>
            <!-- Mensaje del asistente (Markdown renderizado) -->
            <template x-if="msg.role === 'assistant'">
              <div class="text-sm markdown-content" x-html="formatMarkdown(msg.content)"></div>
            </template>
          </div>
        </div>
      </template>

      <!-- Indicador de carga -->
      <template x-if="isLoading">
        <div class="flex justify-start">
          <div class="bg-gray-800 text-gray-100 rounded-2xl rounded-tl-sm px-4 py-2.5">
            <div class="flex space-x-2">
              <div class="w-2 h-2 bg-gray-500 rounded-full animate-bounce" style="animation-delay: 0ms"></div>
              <div class="w-2 h-2 bg-gray-500 rounded-full animate-bounce" style="animation-delay: 150ms"></div>
              <div class="w-2 h-2 bg-gray-500 rounded-full animate-bounce" style="animation-delay: 300ms"></div>
            </div>
          </div>
        </div>
      </template>
    </div>

    <!-- Input de mensaje -->
    <div class="p-4 border-t border-gray-800">
      <form @submit.prevent="sendMessage" class="relative">
        <input
          x-model="inputMessage"
          type="text"
          placeholder="Escribe tu mensaje..."
          class="w-full px-4 py-3 pr-12 rounded-lg bg-gray-800 text-gray-100 placeholder-gray-400 border border-gray-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
          :disabled="isLoading"
        />
        <button
          type="submit"
          class="absolute right-2 top-1/2 -translate-y-1/2 p-2 bg-blue-600 hover:bg-blue-700 rounded-lg transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
          :disabled="!inputMessage.trim() || isLoading"
        >
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
            <path d="M10.894 2.553a1 1 0 00-1.788 0l-7 14a1 1 0 001.169 1.409l5-1.429A1 1 0 009 15.571V11a1 1 0 112 0v4.571a1 1 0 00.725.962l5 1.428a1 1 0 001.17-1.408l-7-14z" />
          </svg>
        </button>
      </form>
    </div>
  </div>
</div>

<style is:global>
  /* Estilos para el contenido Markdown renderizado en los mensajes del asistente */
  .markdown-content h1,
  .markdown-content h2,
  .markdown-content h3,
  .markdown-content h4 {
    color: #f3f4f6;
    font-weight: 600;
    margin-top: 1em;
    margin-bottom: 0.5em;
  }

  .markdown-content h1 { font-size: 1.25rem; }
  .markdown-content h2 { font-size: 1.125rem; }
  .markdown-content h3 { font-size: 1rem; }
  .markdown-content h4 { font-size: 0.95rem; }

  .markdown-content p {
    margin-bottom: 0.75em;
    line-height: 1.6;
  }

  .markdown-content ul,
  .markdown-content ol {
    margin: 0.5em 0;
    padding-left: 1.5em;
  }

  .markdown-content li {
    margin-bottom: 0.25em;
  }

  .markdown-content strong {
    color: #ffffff;
    font-weight: 600;
  }

  .markdown-content code {
    background-color: rgba(0, 0, 0, 0.3);
    padding: 0.125rem 0.25rem;
    border-radius: 0.25rem;
    font-size: 0.875em;
    font-family: 'Courier New', monospace;
  }

  .markdown-content pre {
    background-color: rgba(0, 0, 0, 0.4);
    padding: 0.75rem;
    border-radius: 0.375rem;
    overflow-x: auto;
    margin: 0.75em 0;
  }

  .markdown-content pre code {
    background-color: transparent;
    padding: 0;
  }

  .markdown-content table {
    width: 100%;
    border-collapse: collapse;
    margin: 0.75em 0;
    font-size: 0.875rem;
  }

  .markdown-content th,
  .markdown-content td {
    border: 1px solid #4b5563;
    padding: 0.5rem;
    text-align: left;
  }

  .markdown-content th {
    background-color: rgba(0, 0, 0, 0.3);
    font-weight: 600;
  }

  .markdown-content blockquote {
    border-left: 3px solid #3b82f6;
    padding-left: 1rem;
    margin: 0.75em 0;
    font-style: italic;
    color: #d1d5db;
  }

  .markdown-content a {
    color: #60a5fa !important;
    text-decoration: underline !important;
    text-decoration-thickness: 2px !important;
    text-underline-offset: 3px !important;
    font-weight: 500;
    transition: all 0.2s ease;
  }

  .markdown-content a:hover {
    color: #93c5fd !important;
    text-decoration-thickness: 2.5px !important;
    text-decoration-color: #93c5fd !important;
  }

  /* Eliminar márgenes en el primer y último elemento */
  .markdown-content > *:first-child {
    margin-top: 0;
  }

  .markdown-content > *:last-child {
    margin-bottom: 0;
  }
</style>
